<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderlistSQL">
	
	<!-- 마이페이지 주문 리스트 -->
	<select id="mypage_orderlist" parameterType="java.util.Map" resultType="orderlist">
		select * from 
		(select rownum rn, tt.* from
			(select * from TBL_ORDERLIST
				where userId=#{userId} order by orderDate desc) tt)
		where rn between #{startNum} and #{endNum}
	</select>
	
	<!-- 마이페이지 주문리스트 총 수 -->
	<select id="getTotalAS" parameterType="java.util.Map" resultType="Integer">
		select count(*) from TBL_ORDERLIST where userId=#{userId}
	</select>
	
	
	<!-- 주문취소 - 상태 변경 및 crPayment 업데이트 -->
	<update id="orderCancel" parameterType="java.util.Map">
		begin
			<!-- tbl_orderlist -->
			update TBL_ORDERLIST set crPayment=#{crPayment}, 
										orderState=0 
				where orderCode=#{orderCode};
			
			<!-- tbl_order -->
			update TBL_ORDER set orderState=0,
								cancel=1,
								cancelAmount=totalPrice,
								cancelQty=purchaseQty
				where orderCode=#{orderCode};
			
			<!-- 총구매금액 변경 -->
			update tbl_user set totalPayment = #{x_totalPayment} - #{crPayment} where userId = #{userId};
			
			<!-- 현재 포인트 금액 변경 -->
			update tbl_user set userPoint = #{x_userPoint}
			+ (select usePoint from tbl_point where orderCode = #{orderCode})
			- (select savePoint from tbl_point where orderCode = #{orderCode})
			where userId = #{userId};
			
			<!-- 포인트 내역 변경 -->
			delete tbl_point where userId = #{userId} and orderCode = #{orderCode};
		end;
	</update>
	
	<!-- 교환접수 - 상태 변경 업데이트 -->
	<update id="orderChange" parameterType="String">
		begin	
			<!-- tbl_orderlist -->
			update TBL_ORDERLIST set orderState=5 
				where orderCode=#{orderCode};
			<!-- tbl_order -->
			update TBL_ORDER set orderState=5,
							exchange=1,
							exchangeQty=purchaseQty 	
				where orderCode=#{orderCode};
		end;
	</update>
	
	<!-- 환불접수 - 상태 변경 업데이트 -->
	<update id="orderRefund" parameterType="String">
		begin	
			<!-- tbl_orderlist -->
			update TBL_ORDERLIST set orderState=7 
				where orderCode=#{orderCode};
				
			<!-- tbl_order -->
			update TBL_ORDER set orderState=7,
							refund=1,
							refundQty=purchaseQty,
							refundAmount=totalPrice 
				where orderCode=#{orderCode};
		end;
	</update>
	
	
	
</mapper>